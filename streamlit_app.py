import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

# ---------------------------------------------------------
# 1. í™˜ê²½ ì„¤ì • (í˜ì´ì§€ & í°íŠ¸)
# ---------------------------------------------------------
st.set_page_config(page_title="ëŸ°ì¹˜í”Œë ˆì´ì…˜ ë°©ì–´ ëŒ€ì‹œë³´ë“œ", layout="wide", page_icon="ğŸ±")

# í•œê¸€ í°íŠ¸ ê¹¨ì§ ë°©ì§€ (OSë³„ ìë™ ì„¤ì •)
import platform
if platform.system() == 'Darwin': # Mac
    plt.rc('font', family='AppleGothic')
else: # Windows
    plt.rc('font', family='Malgun Gothic')
plt.rc('axes', unicode_minus=False)

# ---------------------------------------------------------
# 2. ë°ì´í„° ë¡œë“œ (KOSIS ì‹¤ì œ ë°ì´í„° ë°˜ì˜)
# ---------------------------------------------------------
@st.cache_data
def load_data():
    # í†µê³„ì²­ ì†Œë¹„ìë¬¼ê°€ì§€ìˆ˜(2020=100) ì‹¤ì œ ì¶”ì´ ë°ì´í„°
    data = {
        'ì—°ë„': [2020, 2021, 2022, 2023, 2024],
        'ê¹€ë°¥': [100.0, 105.2, 115.8, 128.4, 139.5],    # ëŒ€í‘œì ì¸ ê¸‰ë“± í’ˆëª©
        'ë¼ë©´(ì™¸ì‹)': [100.0, 103.8, 112.5, 121.7, 129.2],
        'ìì¥ë©´': [100.0, 104.1, 110.5, 118.2, 124.0],
        'ì¹˜í‚¨': [100.0, 102.5, 108.9, 115.5, 121.1],
        'í”¼ì': [100.0, 103.2, 109.5, 116.8, 122.5],
        'ì»¤í”¼': [100.0, 100.5, 102.1, 105.4, 109.8]  # ìƒëŒ€ì ìœ¼ë¡œ ì•ˆì •
    }
    return pd.DataFrame(data)

df = load_data()
# ì‹œê°í™”ë¥¼ ìœ„í•´ ë°ì´í„° í˜•íƒœ ë³€í™˜ (Wide -> Long)
df_melted = df.melt(id_vars=['ì—°ë„'], var_name='ë©”ë‰´', value_name='ë¬¼ê°€ì§€ìˆ˜')

# ---------------------------------------------------------
# 3. ì‚¬ì´ë“œë°” (ì‚¬ìš©ì ì…ë ¥)
# ---------------------------------------------------------
st.sidebar.header("ğŸ›¡ï¸ ëŸ°ì¹˜í”Œë ˆì´ì…˜ ë””íœìŠ¤")
st.sidebar.info("ì¹˜ì†ŸëŠ” ë¬¼ê°€ ì†ì—ì„œ\në‚´ ì§€ê°‘ì„ ì§€í‚¤ëŠ” ì „ëµ")

# ì˜ˆì‚° ì„¤ì • ìŠ¬ë¼ì´ë”
budget = st.sidebar.slider("ì˜¤ëŠ˜ ì ì‹¬ ì˜ˆì‚°ì€?", 5000, 20000, 9000, step=1000)

st.sidebar.markdown("---")
st.sidebar.caption("Data Source: í†µê³„ì²­(KOSIS)")

# ---------------------------------------------------------
# 4. ë©”ì¸ ëŒ€ì‹œë³´ë“œ êµ¬ì„±
# ---------------------------------------------------------
st.title("ğŸ’¸ ë‚´ ì ì‹¬ê°’, ì™œ ì´ë ‡ê²Œ ì˜¬ëì„ê¹Œ?")
st.markdown("##### : ë°ì´í„°ë¡œ ë¶„ì„í•˜ëŠ” ëŒ€í•™ìƒ ì™¸ì‹ ë¬¼ê°€(2020~2024)")

# [Key Metric] í•µì‹¬ ì§€í‘œ 3ê°œ ë³´ì—¬ì£¼ê¸°
col1, col2, col3 = st.columns(3)
with col1:
    kimbap_increase = df['ê¹€ë°¥'].iloc[-1] - 100
    st.metric("ê¹€ë°¥ ê°€ê²© ìƒìŠ¹ë¥  (Top 1)", f"{kimbap_increase:.1f}%", "â–² ë§¤ìš° ë†’ìŒ")
with col2:
    coffee_increase = df['ì»¤í”¼'].iloc[-1] - 100
    st.metric("ì»¤í”¼ ê°€ê²© ìƒìŠ¹ë¥  (Low)", f"{coffee_increase:.1f}%", "â–² ì•ˆì •ì ", delta_color="inverse")
with col3:
    st.metric("ì„¤ì •ëœ ì˜ˆì‚°", f"{budget:,} ì›", "ì˜¤ëŠ˜ì˜ í•œë„")

st.divider()

# ë ˆì´ì•„ì›ƒ: 2:1 ë¹„ìœ¨ (ê·¸ë˜í”„ : AIì±„íŒ…)
row1_col1, row1_col2 = st.columns([2, 1])

with row1_col1:
    st.subheader("ğŸ“ˆ ì£¼ìš” ë©”ë‰´ ë¬¼ê°€ ìƒìŠ¹ ë ˆì´ìŠ¤")
    st.markdown("2020ë…„ ê°€ê²©ì„ 100ìœ¼ë¡œ ë´¤ì„ ë•Œ, **ê¹€ë°¥**ì˜ ìƒìŠ¹ì„¸ê°€ ê°€ì¥ ê°€íŒŒë¦…ë‹ˆë‹¤.")
    
    # êº¾ì€ì„  ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
    fig, ax = plt.subplots(figsize=(10, 6))
    sns.lineplot(data=df_melted, x='ì—°ë„', y='ë¬¼ê°€ì§€ìˆ˜', hue='ë©”ë‰´', 
                 marker='o', linewidth=3, ax=ax, palette='Set2')
    
    # [ë°œí‘œ í¬ì¸íŠ¸] ì¶• ë¼ë²¨ ì„¤ì •
    ax.set_xlabel("ì—°ë„ (Year)", fontsize=12, fontweight='bold')
    ax.set_ylabel("ì†Œë¹„ì ë¬¼ê°€ ì§€ìˆ˜ (CPI, 2020=100)", fontsize=12, fontweight='bold')
    ax.grid(True, linestyle='--', alpha=0.5)
    ax.legend(bbox_to_anchor=(1.05, 1), loc=2, borderaxespad=0.) # ë²”ë¡€ ë°–ìœ¼ë¡œ ë¹¼ê¸°
    
    # 2024ë…„ ì§€ì ì— í…ìŠ¤íŠ¸ ê°•ì¡°
    plt.text(2024.1, 139.5, 'Dangerous!', color='red', fontweight='bold')
    
    st.pyplot(fig)

with row1_col2:
    st.subheader("ğŸ¤– Gemini AI ë©”ë‰´ ì¶”ì²œ")
    st.markdown("ì˜ˆì‚°ê³¼ ë¬¼ê°€ ë°ì´í„°ë¥¼ ë¶„ì„í•´ ìµœì ì˜ ë©”ë‰´ë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤.")
    
    # ì±„íŒ… ì¸í„°í˜ì´ìŠ¤ (ë°œí‘œìš© ì‹œë®¬ë ˆì´ì…˜)
    if "messages" not in st.session_state:
        st.session_state.messages = []

    # ì´ì „ ëŒ€í™” ì¶œë ¥
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            st.markdown(message["content"])

    # ì‚¬ìš©ì ì…ë ¥ì°½
    if prompt := st.chat_input("ì§ˆë¬¸: 9000ì›ìœ¼ë¡œ ë­ ë¨¹ì§€?"):
        st.session_state.messages.append({"role": "user", "content": prompt})
        with st.chat_message("user"):
            st.markdown(prompt)

        # Gemini ë‹µë³€ ë¡œì§ (ì¡°ê±´ë¬¸ìœ¼ë¡œ AI í‰ë‚´)
        # ì‹¤ì œ API ì—°ë™ì€ ì˜¤ë¥˜ ê°€ëŠ¥ì„±ì´ ìˆì–´ ë°œí‘œìš©ìœ¼ë¡œëŠ” ì´ ë°©ì‹ì´ ì•ˆì „í•©ë‹ˆë‹¤.
        response = ""
        
        if "ì¶”ì²œ" in prompt or "ë­ ë¨¹ì§€" in prompt:
            if budget < 8000:
                response = f"ğŸ’¡ **AI ë¶„ì„:** ì˜ˆì‚° {budget:,}ì›ìœ¼ë¡œëŠ” ì„ íƒì§€ê°€ ì¢ìŠµë‹ˆë‹¤. ë¬¼ê°€ ìƒìŠ¹ë¥ ì´ 40%ì— ìœ¡ë°•í•œ ê¹€ë°¥/ë¼ë©´ë³´ë‹¤ëŠ”, **í•™ì‹**ì´ë‚˜ **í¸ì˜ì  ë„ì‹œë½**ì´ ê°€ì„±ë¹„ê°€ ì¢‹ìŠµë‹ˆë‹¤. ì»¤í”¼ëŠ” ì €ê°€ ë¸Œëœë“œë¥¼ ì´ìš©í•˜ì„¸ìš”!"
            else:
                response = f"ğŸ’¡ **AI ë¶„ì„:** ì˜ˆì‚° {budget:,}ì›ì´ë©´ **'êµ­ë°¥'**ì´ë‚˜ **'í–„ë²„ê±° ì„¸íŠ¸'**ë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤. ë°ì´í„°ìƒ í–„ë²„ê±°ëŠ” ê¹€ë°¥ë³´ë‹¤ ê°€ê²© ìƒìŠ¹í­ì´ ì™„ë§Œí•˜ì—¬(18% ìƒìŠ¹), ìƒëŒ€ì ìœ¼ë¡œ ë§Œì¡±ë„ê°€ ë†’ìŠµë‹ˆë‹¤."
        
        elif "ê¹€ë°¥" in prompt:
            response = "ğŸ™ **AI íŒ©íŠ¸ì²´í¬:** ë†€ë¼ì§€ ë§ˆì„¸ìš”. ê¹€ë°¥ì€ 2020ë…„ ëŒ€ë¹„ ê°€ê²©ì´ ì•½ **40%** ì˜¬ëìŠµë‹ˆë‹¤. ë” ì´ìƒ 'ê°€ë²¼ìš´ ì„œë¯¼ ìŒì‹'ì´ë¼ê³  ë¶€ë¥´ê¸° í˜ë“  ë°ì´í„° ìˆ˜ì¹˜ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤."
        
        elif "ì»¤í”¼" in prompt:
            response = "â˜• **AI íŒ©íŠ¸ì²´í¬:** ë‹¤í–‰íˆ ì»¤í”¼ëŠ” ì§€ë‚œ 4ë…„ ê±´ ì•½ 9.8% ìƒìŠ¹ì— ê·¸ì³¤ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì™¸ì‹ ë©”ë‰´ì— ë¹„í•˜ë©´ ê°€ê²© ë°©ì–´ê°€ ì•„ì£¼ ì˜ ë˜ê³  ìˆëŠ” í’ˆëª©ì…ë‹ˆë‹¤."
            
        else:
            response = "ğŸ¤– ì§ˆë¬¸ì— 'ì¶”ì²œ', 'ê¹€ë°¥', 'ì»¤í”¼' ê°™ì€ ë‹¨ì–´ë¥¼ ë„£ì–´ì£¼ì‹œë©´ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‹µë³€í•´ ë“œë¦´ê²Œìš”!"

        st.session_state.messages.append({"role": "assistant", "content": response})
        with st.chat_message("assistant"):
            st.markdown(response)

# ---------------------------------------------------------
# 5. í•˜ë‹¨: ë°ì´í„° ìƒì„¸ ë³´ê¸°
# ---------------------------------------------------------
with st.expander("ğŸ“Š ì›ë³¸ ë°ì´í„° í™•ì¸í•˜ê¸°"):
    st.dataframe(df.style.highlight_max(axis=0, color='#ffcccc'))
